version: '3.9'

services:
  mobilia_app:
    build:
      context: ./vendor/laravel/sail/runtimes/8.3
      dockerfile: Dockerfile
      args:
        WWWGROUP: '${WWWGROUP}'
    image: mobilia-app
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '${APP_PORT:-8085}:80'              # Prod app port
      - '${VITE_PORT:-5175}:${VITE_PORT:-5175}'  # Vite port override
    environment:
      WWWUSER: '${WWWUSER}'
      APP_ENV: production
      APP_DEBUG: false
    volumes:
      - '.:/var/www/html'
    networks:
      - mobilia_net
    depends_on:
      mobilia_postgres:
        condition: service_healthy
      mobilia_redis:
        condition: service_healthy
      mobilia_meilisearch:
        condition: service_healthy

  mobilia_postgres:
    image: postgres:13-alpine
    ports:
      - '${FORWARD_DB_PORT:-5532}:5432'    # Avoid clash with local PG
    environment:
      POSTGRES_DB: '${DB_DATABASE}'
      POSTGRES_USER: '${DB_USERNAME}'
      POSTGRES_PASSWORD: '${DB_PASSWORD}'
    volumes:
      - 'mobilia-postgres:/var/lib/postgresql/data'
    networks:
      - mobilia_net
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USERNAME}"]
      interval: 10s
      retries: 5
      timeout: 10s
    restart: unless-stopped

  mobilia_redis:
    image: redis:alpine
    ports:
      - '${FORWARD_REDIS_PORT:-6385}:6379'   # Avoid local redis clash
    volumes:
      - 'mobilia-redis:/data'
    networks:
      - mobilia_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      retries: 5
      timeout: 5s

  mobilia_meilisearch:
    image: getmeili/meilisearch:latest
    ports:
      - '${FORWARD_MEILISEARCH_PORT:-7705}:7700'
    environment:
      MEILI_NO_ANALYTICS: true
    volumes:
      - 'mobilia-meilisearch:/meili_data'
    networks:
      - mobilia_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--spider", "http://localhost:7700/health"]
      interval: 10s
      retries: 3
      timeout: 5s

networks:
  mobilia_net:
    driver: bridge

volumes:
  mobilia-postgres:
    driver: local
  mobilia-redis:
    driver: local
  mobilia-meilisearch:
    driver: local
