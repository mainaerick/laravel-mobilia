services:
  mobilia_app:
    mem_limit: 512
    mem_reservation: 256m
    build:
      context: ./vendor/laravel/sail/runtimes/8.3
      dockerfile: Dockerfile
      args:
        WWWGROUP: '${WWWGROUP}'
    image: mobilia-app
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '${APP_PORT:-8085}:80'              # Prod app port
      - '${VITE_PORT:-5175}:${VITE_PORT:-5175}'  # Vite port override
    environment:
      WWWUSER: '${WWWUSER}'
      APP_ENV: production
      APP_DEBUG: false
      APP_KEY: '${APP_KEY}'
      DB_CONNECTION: '${DB_CONNECTION}'
      DB_HOST: '${DB_HOST}'
      DB_PORT: '${DB_PORT}'
      DB_DATABASE: '${DB_DATABASE}'
      DB_USERNAME: '${DB_USERNAME}'
      DB_PASSWORD: '${DB_PASSWORD}'
      REDIS_HOST: '${REDIS_HOST}'
      REDIS_PORT: '${REDIS_PORT}'
      SESSION_DRIVER: '${SESSION_DRIVER}'
      CACHE_STORE: '${CACHE_STORE}'
      QUEUE_CONNECTION: '${QUEUE_CONNECTION}'
    volumes:
      - '.:/var/www/html'
    networks:
      - mobilia_net
    depends_on:
      mobilia_postgres:
        condition: service_healthy
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache
        chown -R sail:sail /var/www/html/storage /var/www/html/bootstrap/cache
        exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
  mobilia_postgres:
    mem_limit: 384m
    mem_reservation: 256m
    image: postgres:13-alpine
    ports:
      - '${FORWARD_DB_PORT:-5532}:5432'    # Avoid clash with local PG
    environment:
      POSTGRES_DB: '${DB_DATABASE}'
      POSTGRES_USER: '${DB_USERNAME}'
      POSTGRES_PASSWORD: '${DB_PASSWORD}'
    volumes:
      - 'mobilia-postgres:/var/lib/postgresql/data'
    networks:
      - mobilia_net
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${DB_USERNAME}", "-d", "${DB_DATABASE}"]
      interval: 10s
      retries: 5
      timeout: 10s
    restart: unless-stopped

networks:
  mobilia_net:
    driver: bridge
volumes:
  mobilia-postgres:
    driver: local
  mobilia-storage:
    driver: local
  mobilia-bootstrap-cache:
    driver: local
